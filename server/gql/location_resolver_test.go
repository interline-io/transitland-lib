package gql

import (
	"testing"
)

func TestLocationResolver(t *testing.T) {
	testcases := []testcase{
		{
			name: "locations for ctran",
			query: `query {
				feed_versions(where: {sha1: "e8bc76c3c8602cad745f41a49ed5c5627ad6904c"}) {
					sha1
					locations(limit: 1) {
						id
					}
				}
			}`,
			expect: `{"feed_versions":[{"locations":[{"id":2}],"sha1":"e8bc76c3c8602cad745f41a49ed5c5627ad6904c"}]}`,
		},
		{
			name: "location fields",
			query: `query {
				feed_versions(where: {sha1: "e8bc76c3c8602cad745f41a49ed5c5627ad6904c"}) {
					locations(limit: 1) {
						location_id
						stop_name
						stop_desc
						zone_id
						stop_url
						geometry
						feed_version {
							sha1
						}
					}
				}
			}`,
			expect: `{"feed_versions":[{"locations":[{"feed_version":{"sha1":"e8bc76c3c8602cad745f41a49ed5c5627ad6904c"},"geometry":{"coordinates":[[[-122.70795308873225,45.64654911750975],[-122.70543485328184,45.64564395502827],[-122.70369213730416,45.64402294358435],[-122.70251436572727,45.64289874985856],[-122.70185046051219,45.64221949472791],[-122.70112178405661,45.64180061662554],[-122.69993970891748,45.64130248723807],[-122.69956727428468,45.641110026970516],[-122.69925485874295,45.64102423957697],[-122.6989956654361,45.64077045431634],[-122.69967502929185,45.63872593584637],[-122.70001471121971,45.63819930536975],[-122.69976093595197,45.63797302985947],[-122.69796451887362,45.636873987354896],[-122.69555058342452,45.63514687701007],[-122.69434361569786,45.634263675011915],[-122.69337703229209,45.63371091138288],[-122.69235207407706,45.633505301870215],[-122.6916883716264,45.633472991735296],[-122.6916814044826,45.6334646143126],[-122.69167539579706,45.63345747167912],[-122.69166938711153,45.6334515895097],[-122.69166277755751,45.63344696780472],[-122.69165556713492,45.63344234609939],[-122.69164771557622,45.633436890010785],[-122.69163439253846,45.633427464915776],[-122.69161961190258,45.6334166540868],[-122.69160562723822,45.63341297125162],[-122.69142846811005,45.6334080161349],[-122.69137532037162,45.633360942504524],[-122.69111666804024,45.63337580788109],[-122.69086155889575,45.633373330321206],[-122.69036905651961,45.633373330321206],[-122.68939113813252,45.63337085276119],[-122.68840259019076,45.63331139129474],[-122.68778961960759,45.63307106719501],[-122.68773185899036,45.6330269755681],[-122.6865330517434,45.63331221867276],[-122.68663469104514,45.63363319838312],[-122.68734875381739,45.64034961890955],[-122.69441854421923,45.64035021288164],[-122.6970895015652,45.64073247922952],[-122.69635023680753,45.64354810221654],[-122.69836085690848,45.64376803343448],[-122.6970028855011,45.64836487430656],[-122.70284012126672,45.65120841974441],[-122.70512327274007,45.65273206103978],[-122.70795308873225,45.64654911750975]]],"type":"Polygon"},"location_id":"location_id__11f830d0-adec-468a-a8d6-513184e476a1","stop_desc":null,"stop_name":"Port of Vancouver","stop_url":null,"zone_id":null}]}]}`,
		},
		{
			name: "location filter by id",
			query: `query {
				feed_versions(where: {sha1: "e8bc76c3c8602cad745f41a49ed5c5627ad6904c"}) {
					locations(where: {location_id: ["location_id__11f830d0-adec-468a-a8d6-513184e476a1"]}) {
						location_id
					}
				}
			}`,
			expect: `{"feed_versions":[{"locations":[{"location_id":"location_id__11f830d0-adec-468a-a8d6-513184e476a1"}]}]}`,
		},
		{
			name: "location stop times",
			query: `query {
				feed_versions(where: {sha1: "e8bc76c3c8602cad745f41a49ed5c5627ad6904c"}) {
					locations(limit: 1) {
						stop_times(limit: 1) {
							arrival_time
						}
					}
				}
			}`,
			expect: `{"feed_versions":[{"locations":[{"stop_times":[]}]}]}`,
		},
	}
	c, _ := newTestClient(t)
	for _, tc := range testcases {
		t.Run(tc.name, func(t *testing.T) {
			queryTestcase(t, c, tc)
		})
	}
}
